<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Middleware as an Abstraction</title>

  <meta name="viewport" content="width=device-width"/>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>
  <script type="text/javascript" src="./js/coffee-script.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/style.css" type="text/css"/>
  

  

  <script type="text/javascript">
  $(function(){
      setupPreso(false, './');
  });
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content link" ref="one/01_slide/1">
<h1><b>Middleware</b><br/><span class="small">A General Abstraction</span></h1>

<p>johnbender.github.com/presentation-middleware</p></div>
</div><div class="slide" data-transition="none"><div class="content bullets mono-bullets" ref="one/01_slide/2">
<h2>me</h2>

<ul>
<li>@johnbender</li>
<li>johnbender.us</li>
<li>github.com/johnbender</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content center" ref="one/01_slide/3">
<p><img src="./file/one/adobe.jpg" style="max-height: 600px"/></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/4">
<h1>Large Classes</h1>

<h3>&#x3B5;(&#xB4;&#xFB41;&#xFE35;&#xFB41;`)&#x437;</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/5">
<h2>Mixin All The Things</h2>

<h3>(&#xFF89; `&#x414;&#xB4;)&#xFF89; &#xFE35; &#x253B;&#x2501;&#x253B;</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/6">
<pre class="xxlarge">
<span class="keyword">module</span> <span class="type">Authlogic</span>
  <span class="keyword">module</span> <span class="type">Session</span> <span class="comment-delimiter"># </span><span class="comment">:nodoc:
</span>    <span class="comment-delimiter"># </span><span class="comment">This is the base class Authlogic, where all modules are included.
</span>    <span class="comment-delimiter"># </span><span class="comment">For information on functiionality see the various sub modules.
</span>    <span class="keyword">class</span> <span class="type">Base</span>
      include <span class="type">Foundation</span>
      include <span class="type">Callbacks</span>

      <span class="comment-delimiter"># </span><span class="comment">Included first so that the session resets itself to nil
</span>      include <span class="type">Timeout</span>

      <span class="comment-delimiter"># </span><span class="comment">Included in a specific order so they are tried in this order when persisting
</span>      include <span class="type">Params</span>
      include <span class="type">Cookies</span>
      include <span class="type">Session</span>
      include <span class="type">HttpAuth</span>

      <span class="comment-delimiter"># </span><span class="comment">Included in a specific order so magic states gets ran after a record is found
</span>      include <span class="type">Password</span>
      include <span class="type">UnauthorizedRecord</span>
      include <span class="type">MagicStates</span>

      include <span class="type">Activation</span>
      include <span class="type">ActiveRecordTrickery</span>
      include <span class="type">BruteForceProtection</span>
      include <span class="type">Existence</span>
      include <span class="type">Klass</span>
      include <span class="type">MagicColumns</span>
      include <span class="type">PerishableToken</span>
      include <span class="type">Persistence</span>
      include <span class="type">Scopes</span>
      include <span class="type">Id</span>
      include <span class="type">Validation</span>
      include <span class="type">PriorityRecord</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/7">
<h2>Object Composition</h2>

<h3>(&#x273F; &#x2665;&#x203F;&#x2665;)</h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/8">
<pre>
<span class="keyword">class</span> <span class="type">Lamp</span>
  <span class="keyword">def</span> <span class="function-name">initialize</span>(bulb_age)
    <span class="variable-name">@bulb_age</span> = bulb_age
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">needs_maintenance?</span>
    <span class="variable-name">@bulb_age</span> &gt; 2
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/9">
<pre>
<span class="keyword">class</span> <span class="type">Lamp</span>
  <span class="keyword">def</span> <span class="function-name">initialize</span>(bulb_age)
    <span class="variable-name">@bulb_age</span> = bulb_age
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">needs_maintenance?</span>
    <b><span class="variable-name">@bulb_age</span> &gt; 2</b>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/10">
<pre>
<span class="keyword">class</span> <span class="type">Lamp</span>
  <span class="keyword">def</span> <span class="function-name">initialize</span>(bulb)
    <span class="variable-name">@bulb</span> = bulb
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">needs_maintenance?</span>
    <b><span class="variable-name">@bulb</span>.needs_maintenance?</b>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/11">
<h2>Middlethangs</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/12">
<h1>Rack Middleware</h1></div>
</div><div class="slide" data-transition="none"><div class="content link" ref="one/01_slide/13">
<h3>Python Web Server Gateway Interface v1.0</h3>

<p>python.org/dev/peps/pep-0333/</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/14">
<h2>Request Processing</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/15">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   use <span class="type">Middleware</span>::<span class="type">Example</span>
   use <span class="type">Rack</span>::<span class="type">CommonLogger</span>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/16">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   use <span class="type">Middleware</span>::<span class="type">Example</span>
   use <span class="type">Rack</span>::<span class="type">CommonLogger</span>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/17">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   <b>use <span class="type">Middleware</span>::<span class="type">Example</span></b>
   use <span class="type">Rack</span>::<span class="type">CommonLogger</span>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/18">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <span class="variable-name">@app</span>.call(env)

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/19">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <b><span class="variable-name">@app</span> = app</b>
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <span class="variable-name">@app</span>.call(env)

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/20">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <b><span class="variable-name">@app</span>.call(env)</b>

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/21">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   use <span class="type">Middleware</span>::<span class="type">Example</span>
   <b>use <span class="type">Rack</span>::<span class="type">CommonLogger</span></b>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/22">
<pre>
<span class="type">Rack</span>::<span class="type">Handler</span>::<span class="type">Puma</span>.run(app)
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/23">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   use <span class="type">Middleware</span>::<span class="type">Example</span>
   use <span class="type">Rack</span>::<span class="type">CommonLogger</span>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/24">
<pre>
app = <span class="type">Rack</span>::<span class="type">Builder</span>.new <span class="keyword">do</span>
   <b>use <span class="type">Middleware</span>::<span class="type">Example</span></b>
   use <span class="type">Rack</span>::<span class="type">CommonLogger</span>
   use <span class="type">Rack</span>::<span class="type">ShowExceptions</span>
<span class="keyword">end</span></pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/25">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <b><span class="function-name">call</span>(env)</b>
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <span class="variable-name">@app</span>.call(env)

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/26">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(<b>env</b>)
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <span class="variable-name">@app</span>.call(<b>env</b>)

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/27">
<pre class="large">
<span class="keyword">module</span> <span class="type">Middleware</span>
  <span class="keyword">class</span> <span class="type">Example</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="comment-delimiter"># </span><span class="comment">do something before the next middleware
</span>      <span class="comment-delimiter"># </span><span class="comment">possibly modify the environment
</span>
      <span class="comment-delimiter"># </span><span class="comment">run the next middleware in the stack
</span>      <b><span class="variable-name">@app</span>.call(env)</b>

      <span class="comment-delimiter"># </span><span class="comment">do something after the next middleware
</span>    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/28">
<h2>Endpoints</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/29">
<div class="question">&#x61F;</div>


</div>
</div><div class="slide" data-transition="none"><div class="content link" ref="one/01_slide/30">
<h1>Vagrant</h1>

<p>vagrantup.com</p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/31">
<h2>Virtual Machines</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/32">
<h3><code>$ vagrant suspend</code></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/33">
<pre>
<span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">General</span>::<span class="type">Validate</span>
  use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
  use <span class="type">VM</span>::<span class="type">Suspend</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/34">
<pre>
<span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">General</span>::<span class="type">Validate</span>
  use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
  use <span class="type">VM</span>::<span class="type">Suspend</span>
<span class="keyword">end</span>
</pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/35">
<pre>
<span class="type">Builder</span>.new <span class="keyword">do</span>
  <b>use <span class="type">General</span>::<span class="type">Validate</span></b>
  use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
  use <span class="type">VM</span>::<span class="type">Suspend</span>
<span class="keyword">end</span>
</pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/36">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">General</span>
  <span class="keyword">class</span> <span class="type">Validate</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span>, <span class="variable-name">@env</span> = app, env
    <span class="keyword">end</span>

    <span class="keyword">def</span> <b><span class="function-name">call</span>(env)</b>
      <span class="keyword">if</span> !<span class="variable-name">@env</span>[<span class="string">"validate"</span>]
        <span class="variable-name">@env</span>[<span class="constant">:vm</span>].config.validate!(<span class="variable-name">@env</span>[<span class="constant">:vm</span>].env)
      <span class="keyword">end</span>

      <span class="variable-name">@app</span>.call(<span class="variable-name">@env</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/37">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">General</span>
  <span class="keyword">class</span> <span class="type">Validate</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span>, <span class="variable-name">@env</span> = app, env
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="keyword">if</span> !<span class="variable-name">@env</span>[<span class="string">"validate"</span>]
        <b><span class="variable-name">@env</span>[<span class="constant">:vm</span>].config.validate!(<span class="variable-name">@env</span>[<span class="constant">:vm</span>].env)</b>
      <span class="keyword">end</span>

      <span class="variable-name">@app</span>.call(<span class="variable-name">@env</span>)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/38">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">General</span>
  <span class="keyword">class</span> <span class="type">Validate</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span>, <span class="variable-name">@env</span> = app, env
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="keyword">if</span> !<span class="variable-name">@env</span>[<span class="string">"validate"</span>]
        <span class="variable-name">@env</span>[<span class="constant">:vm</span>].config.validate!(<span class="variable-name">@env</span>[<span class="constant">:vm</span>].env)
      <span class="keyword">end</span>

      <b><span class="variable-name">@app</span>.call(<span class="variable-name">@env</span>)</b>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/39">
<pre>
<span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">General</span>::<span class="type">Validate</span>
  <b>use <span class="type">VM</span>::<span class="type">CheckAccessible</span></b>
  use <span class="type">VM</span>::<span class="type">Suspend</span>
<span class="keyword">end</span>
</pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/40">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">VM</span>
  <span class="keyword">class</span> <span class="type">CheckAccessible</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <b><span class="function-name">call</span>(env)</b>
      <span class="keyword">if</span> env[<span class="constant">:vm</span>].state == <span class="constant">:inaccessible</span>
        <span class="keyword">raise</span> <span class="type">Errors</span>::<span class="type">VMInaccessible</span>
      <span class="keyword">end</span>

      <span class="variable-name">@app</span>.call(env)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/41">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">VM</span>
  <span class="keyword">class</span> <span class="type">CheckAccessible</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="keyword">if</span> env[<span class="constant">:vm</span>].state == <span class="constant">:inaccessible</span>
        <span class="keyword">raise</span> <span class="type">Errors</span>::<span class="type">VMInaccessible</span>
      <span class="keyword">end</span>

      <b><span class="variable-name">@app</span>.call(env)</b>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/42">
<pre>
<span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">General</span>::<span class="type">Validate</span>
  use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
  <b>use <span class="type">VM</span>::<span class="type">Suspend</span></b>
<span class="keyword">end</span>
</pre>


<p><span class="right-arrow">&#x2193;</span></p></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/43">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">VM</span>
  <span class="keyword">class</span> <span class="type">Suspend</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <b><span class="function-name">call</span>(env)</b>
      <span class="keyword">if</span> env[<span class="constant">:vm</span>].state == <span class="constant">:running</span>
        env[<span class="constant">:vm</span>].driver.suspend
      <span class="keyword">end</span>

      <span class="variable-name">@app</span>.call(env)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/44">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">VM</span>
  <span class="keyword">class</span> <span class="type">Suspend</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="keyword">if</span> env[<span class="constant">:vm</span>].state == <span class="constant">:running</span>
        <b>env[<span class="constant">:vm</span>].driver.suspend</b>
      <span class="keyword">end</span>

      <span class="variable-name">@app</span>.call(env)
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/45">
<pre class="large">
<span class="keyword">module</span> <span class="type">Vagrant</span>::<span class="type">Action</span>::<span class="type">VM</span>
  <span class="keyword">class</span> <span class="type">Suspend</span>
    <span class="keyword">def</span> <span class="function-name">initialize</span>(app, env)
      <span class="variable-name">@app</span> = app
    <span class="keyword">end</span>

    <span class="keyword">def</span> <span class="function-name">call</span>(env)
      <span class="keyword">if</span> env[<span class="constant">:vm</span>].state == <span class="constant">:running</span>
        env[<span class="constant">:vm</span>].driver.suspend
      <span class="keyword">end</span>

      <b><span class="variable-name">@app</span>.call(env)</b>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/46">
<h3><code>$ vagrant up</code></h3></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/47">
<pre class="xlarge">
    <span class="type">Builder</span>.new <span class="keyword">do</span>
      use <span class="type">General</span>::<span class="type">Validate</span>
      use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
      use <span class="type">VM</span>::<span class="type">CheckBox</span>
      use <span class="type">VM</span>::<span class="type">Import</span>
      use <span class="type">VM</span>::<span class="type">CheckGuestAdditions</span>
      use <span class="type">VM</span>::<span class="type">MatchMACAddress</span>
      use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
      use <span class="type">VM</span>::<span class="type">CleanMachineFolder</span>
      use <span class="type">VM</span>::<span class="type">ClearForwardedPorts</span>
      use <span class="type">VM</span>::<span class="type">CheckPortCollisions</span>
      use <span class="type">VM</span>::<span class="type">ForwardPorts</span>
      use <span class="type">VM</span>::<span class="type">Provision</span>
      use <span class="type">VM</span>::<span class="type">NFS</span>
      use <span class="type">VM</span>::<span class="type">ClearSharedFolders</span>
      use <span class="type">VM</span>::<span class="type">ShareFolders</span>
      use <span class="type">VM</span>::<span class="type">HostName</span>
      use <span class="type">VM</span>::<span class="type">ClearNetworkInterfaces</span>
      use <span class="type">VM</span>::<span class="type">Network</span>
      use <span class="type">VM</span>::<span class="type">Customize</span>
      use <span class="type">VM</span>::<span class="type">Boot</span>
    <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/48">
<pre class="xlarge">
    <span class="type">Builder</span>.new <span class="keyword">do</span>
      use <span class="type">General</span>::<span class="type">Validate</span>
      use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
      use <span class="type">VM</span>::<span class="type">CheckBox</span>
      use <span class="type">VM</span>::<span class="type">Import</span>
      use <span class="type">VM</span>::<span class="type">CheckGuestAdditions</span>
      use <span class="type">VM</span>::<span class="type">MatchMACAddress</span>
      use <span class="type">VM</span>::<span class="type">CheckAccessible</span>
      use <span class="type">VM</span>::<span class="type">CleanMachineFolder</span>
      use <span class="type">VM</span>::<span class="type">ClearForwardedPorts</span>
      use <span class="type">VM</span>::<span class="type">CheckPortCollisions</span>
      use <span class="type">VM</span>::<span class="type">ForwardPorts</span>
      use <span class="type">VM</span>::<span class="type">Provision</span>
      use <span class="type">VM</span>::<span class="type">NFS</span>
      use <span class="type">VM</span>::<span class="type">ClearSharedFolders</span>
      use <span class="type">VM</span>::<span class="type">ShareFolders</span>
      use <span class="type">VM</span>::<span class="type">HostName</span>
      use <span class="type">VM</span>::<span class="type">ClearNetworkInterfaces</span>
      use <span class="type">VM</span>::<span class="type">Network</span>
      use <span class="type">VM</span>::<span class="type">Customize</span>
      use <span class="type">VM</span>::<span class="type">Boot</span>
    <span class="keyword">end</span>
</pre>


<div class="gigantor">(&#x256C; &#xCA0;&#x76CA;&#xCA0;)</div>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/49">
<div class="question" style="-webkit-transform: rotate(180deg);">&#x61F;</div>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/50">
<h1>Diaspora User</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/51">
<pre class="extreme">
<span class="keyword">class</span> <span class="type">User</span> &lt; <span class="type">ActiveRecord</span>::<span class="type">Base</span>
  include <span class="type">Diaspora</span>::<span class="type">UserModules</span>
  include <span class="type">Encryptor</span>::<span class="type">Private</span>


  <span class="keyword">def</span> <span class="function-name">self.all_sharing_with_person</span>(person)
    <span class="type">User</span>.joins(<span class="constant">:contacts</span>).where(<span class="constant">:contacts</span> =&gt; {<span class="constant">:person_id</span> =&gt; person.id})
  <span class="keyword">end</span>

  <span class="comment-delimiter"># </span><span class="comment">@return [User]
</span>  <span class="keyword">def</span> <span class="function-name">self.find_by_invitation</span>(invitation)
    service = invitation.service
    identifier = invitation.identifier

    <span class="keyword">if</span> service == <span class="string">'email'</span>
      existing_user = <span class="type">User</span>.where(<span class="constant">:email</span> =&gt; identifier).first
    <span class="keyword">else</span>
      existing_user = <span class="type">User</span>.joins(<span class="constant">:services</span>).where(<span class="constant">:services</span> =&gt; {<span class="constant">:type</span> =&gt; <span class="string">"Services::</span><span class="variable-name">#{service.titleize}</span><span class="string">"</span>, <span class="constant">:uid</span> =&gt; identifier}).first
    <span class="keyword">end</span>

   <span class="keyword">if</span> existing_user.nil?
    i = <span class="type">Invitation</span>.where(<span class="constant">:service</span> =&gt; service, <span class="constant">:identifier</span> =&gt; identifier).first
    existing_user = i.recipient <span class="keyword">if</span> i
   <span class="keyword">end</span>

   existing_user
  <span class="keyword">end</span>

  <span class="comment-delimiter"># </span><span class="comment">@return [User]
</span>  <span class="keyword">def</span> <span class="function-name">self.find_or_create_by_invitation</span>(invitation)
    <span class="keyword">if</span> existing_user = <span class="variable-name">self</span>.find_by_invitation(invitation)
      existing_user
    <span class="keyword">else</span>
     <span class="variable-name">self</span>.create_from_invitation!(invitation)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  # ... to be continued ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/52">
<pre class="extreme">
  <span class="keyword">def</span> <span class="function-name">self.create_from_invitation!</span>(invitation)
    user = <span class="type">User</span>.new
    user.generate_keys
    user.send(<span class="constant">:generate_invitation_token</span>)
    user.email = invitation.identifier <span class="keyword">if</span> invitation.service == <span class="string">'email'</span>
    <span class="comment-delimiter"># </span><span class="comment">we need to make a custom validator here to make this safer
</span>    user.save(<span class="constant">:validate</span> =&gt; <span class="variable-name">false</span>)
    user
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">send_reset_password_instructions</span>
    generate_reset_password_token! <span class="keyword">if</span> should_generate_token?
    <span class="type">Resque</span>.enqueue(<span class="type">Jobs</span>::<span class="type">ResetPassword</span>, <span class="variable-name">self</span>.id)
  <span class="keyword">end</span>


  <span class="keyword">def</span> <span class="function-name">update_user_preferences</span>(pref_hash)
    <span class="keyword">if</span> <span class="variable-name">self</span>.disable_mail
      <span class="type">UserPreference</span>::<span class="type">VALID_EMAIL_TYPES</span>.each{|x| <span class="variable-name">self</span>.user_preferences.find_or_create_by_email_type(x)}
      <span class="variable-name">self</span>.disable_mail = <span class="variable-name">false</span>
      <span class="variable-name">self</span>.save
    <span class="keyword">end</span>

    pref_hash.keys.each <span class="keyword">do</span> |key|
      <span class="keyword">if</span> pref_hash[key] == <span class="string">'true'</span>
        <span class="variable-name">self</span>.user_preferences.find_or_create_by_email_type(key)
      <span class="keyword">else</span>
        block = <span class="variable-name">self</span>.user_preferences.where(<span class="constant">:email_type</span> =&gt; key).first
        <span class="keyword">if</span> block
          block.destroy
        <span class="keyword">end</span>
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">strip_and_downcase_username</span>
    <span class="keyword">if</span> username.present?
      username.strip!
      username.downcase!
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  # ... to be continued ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/53">
<pre class="extreme">

  <span class="keyword">def</span> <span class="function-name">set_current_language</span>
    <span class="variable-name">self</span>.language = <span class="type">I18n</span>.locale.to_s <span class="keyword">if</span> <span class="variable-name">self</span>.language.blank?
  <span class="keyword">end</span>

  <span class="comment-delimiter"># </span><span class="comment">This override allows a user to enter either their email address or their username into the username field.
</span>  <span class="comment-delimiter"># </span><span class="comment">@return [User] The user that matches the username/email condition.
</span>  <span class="comment-delimiter"># </span><span class="comment">@return [nil] if no user matches that condition.
</span>  <span class="keyword">def</span> <span class="function-name">self.find_for_database_authentication</span>(conditions={})
    conditions = conditions.dup
    conditions[<span class="constant">:username</span>] = conditions[<span class="constant">:username</span>].downcase
    <span class="keyword">if</span> conditions[<span class="constant">:username</span>] =~ <span class="string">/^([\w\.%\+\-]+)@([\w\-]+\.)+([\w]{2,})$/</span>i <span class="comment-delimiter"># </span><span class="comment">email regex
</span>      conditions[<span class="constant">:email</span>] = conditions.delete(<span class="constant">:username</span>)
    <span class="keyword">end</span>
    where(conditions).first
  <span class="keyword">end</span>

  <span class="comment-delimiter"># </span><span class="comment">@param [Person] person
</span>  <span class="comment-delimiter"># </span><span class="comment">@return [Boolean] whether this user can add person as a contact.
</span>  <span class="keyword">def</span> <span class="function-name">can_add?</span>(person)
    <span class="keyword">return</span> <span class="variable-name">false</span> <span class="keyword">if</span> <span class="variable-name">self</span>.person == person
    <span class="keyword">return</span> <span class="variable-name">false</span> <span class="keyword">if</span> <span class="variable-name">self</span>.contact_for(person).present?
    <span class="variable-name">true</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">confirm_email</span>(token)
    <span class="keyword">return</span> <span class="variable-name">false</span> <span class="keyword">if</span> token.blank? || token != confirm_email_token
    <span class="variable-name">self</span>.email = unconfirmed_email
    save
  <span class="keyword">end</span>

  <span class="comment-delimiter">######### </span><span class="comment">Aspects ######################
</span>
  <span class="keyword">def</span> <span class="function-name">move_contact</span>(person, to_aspect, from_aspect)
    <span class="keyword">return</span> <span class="variable-name">true</span> <span class="keyword">if</span> to_aspect == from_aspect
    contact = contact_for(person)

    add_contact_to_aspect(contact, to_aspect)

    membership = contact ? <span class="type">AspectMembership</span>.where(<span class="constant">:contact_id</span> =&gt; contact.id, <span class="constant">:aspect_id</span> =&gt; from_aspect.id).first : <span class="variable-name">nil</span>
    <span class="keyword">return</span>(membership &amp;&amp; membership.destroy)
  <span class="keyword">end</span>

  # ... to be continued ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/54">
<pre class="extreme">

  <span class="keyword">def</span> <span class="function-name">add_contact_to_aspect</span>(contact, aspect)
    <span class="keyword">return</span> <span class="variable-name">true</span> <span class="keyword">if</span> <span class="type">AspectMembership</span>.exists?(<span class="constant">:contact_id</span> =&gt; contact.id, <span class="constant">:aspect_id</span> =&gt; aspect.id)
    contact.aspect_memberships.create!(<span class="constant">:aspect</span> =&gt; aspect)
  <span class="keyword">end</span>

  <span class="comment-delimiter">######## </span><span class="comment">Posting ########
</span>  <span class="keyword">def</span> <span class="function-name">build_post</span>(class_name, opts = {})
    opts[<span class="constant">:author</span>] = <span class="variable-name">self</span>.person
    opts[<span class="constant">:diaspora_handle</span>] = opts[<span class="constant">:author</span>].diaspora_handle

    model_class = class_name.to_s.camelize.constantize
    model_class.diaspora_initialize(opts)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">dispatch_post</span>(post, opts = {})
    additional_people = opts.delete(<span class="constant">:additional_subscribers</span>)
    mailman = <span class="type">Postzord</span>::<span class="type">Dispatcher</span>.build(<span class="variable-name">self</span>, post, <span class="constant">:additional_subscribers</span> =&gt; additional_people)
    mailman.post(opts)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">update_post</span>(post, post_hash = {})
    <span class="keyword">if</span> <span class="variable-name">self</span>.owns? post
      post.update_attributes(post_hash)
      <span class="type">Postzord</span>::<span class="type">Dispatcher</span>.build(<span class="variable-name">self</span>, post).post
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">notify_if_mentioned</span>(post)
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="variable-name">self</span>.contact_for(post.author) &amp;&amp; post.respond_to?(<span class="constant">:mentions?</span>)

    post.notify_person(<span class="variable-name">self</span>.person) <span class="keyword">if</span> post.mentions? <span class="variable-name">self</span>.person
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">add_to_streams</span>(post, aspects_to_insert)
    inserted_aspect_ids = aspects_to_insert.map{|x| x.id}

    aspects_to_insert.each <span class="keyword">do</span> |aspect|
      aspect &lt;&lt; post
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  # ... to be continued ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/55">
<pre class="extreme">

  <span class="keyword">def</span> <span class="function-name">aspects_from_ids</span>(aspect_ids)
    <span class="keyword">if</span> aspect_ids == <span class="string">"all"</span> || aspect_ids == <span class="constant">:all</span>
      <span class="variable-name">self</span>.aspects
    <span class="keyword">else</span>
      aspects.where(<span class="constant">:id</span> =&gt; aspect_ids)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">salmon</span>(post)
    <span class="type">Salmon</span>::<span class="type">EncryptedSlap</span>.create_by_user_and_activity(<span class="variable-name">self</span>, post.to_diaspora_xml)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">build_relayable</span>(model, options = {})
    r = model.new(options.merge(<span class="constant">:author_id</span> =&gt; <span class="variable-name">self</span>.person.id))
    r.set_guid
    r.initialize_signatures
    r
  <span class="keyword">end</span>

  <span class="comment-delimiter">######## </span><span class="comment">Commenting  ########
</span>  <span class="keyword">def</span> <span class="function-name">build_comment</span>(options = {})
    build_relayable(<span class="type">Comment</span>, options)
  <span class="keyword">end</span>

  <span class="comment-delimiter">######## </span><span class="comment">Liking  ########
</span>  <span class="keyword">def</span> <span class="function-name">build_like</span>(options = {})
    build_relayable(<span class="type">Like</span>, options)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">liked?</span>(target)
    <span class="keyword">if</span> target.likes.loaded?
      <span class="keyword">if</span> <span class="variable-name">self</span>.like_for(target)
        <span class="keyword">return</span> <span class="variable-name">true</span>
      <span class="keyword">else</span>
        <span class="keyword">return</span> <span class="variable-name">false</span>
      <span class="keyword">end</span>
    <span class="keyword">else</span>
      <span class="type">Like</span>.exists?(<span class="constant">:author_id</span> =&gt; <span class="variable-name">self</span>.person.id, <span class="constant">:target_type</span> =&gt; target.class.base_class.to_s, <span class="constant">:target_id</span> =&gt; target.id)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  # ... to be continued ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/56">
<pre class="extreme">

  <span class="comment-delimiter"># </span><span class="comment">Get the user's like of a post, if there is one.
</span>  <span class="comment-delimiter"># </span><span class="comment">@param [Post] post
</span>  <span class="comment-delimiter"># </span><span class="comment">@return [Like]
</span>  <span class="keyword">def</span> <span class="function-name">like_for</span>(target)
    <span class="keyword">if</span> target.likes.loaded?
      <span class="keyword">return</span> target.likes.detect{ |like| like.author_id == <span class="variable-name">self</span>.person.id }
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="type">Like</span>.where(<span class="constant">:author_id</span> =&gt; <span class="variable-name">self</span>.person.id, <span class="constant">:target_type</span> =&gt; target.class.base_class.to_s, <span class="constant">:target_id</span> =&gt; target.id).first
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="comment-delimiter">######### </span><span class="comment">Mailer #######################
</span>  <span class="keyword">def</span> <span class="function-name">mail</span>(job, *args)
    pref = job.to_s.gsub(<span class="string">'Jobs::Mail::'</span>, <span class="string">''</span>).underscore
    <span class="keyword">if</span>(<span class="variable-name">self</span>.disable_mail == <span class="variable-name">false</span> &amp;&amp; !<span class="variable-name">self</span>.user_preferences.exists?(<span class="constant">:email_type</span> =&gt; pref))
      <span class="type">Resque</span>.enqueue(job, *args)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">mail_confirm_email</span>
    <span class="keyword">return</span> <span class="variable-name">false</span> <span class="keyword">if</span> unconfirmed_email.blank?
    <span class="type">Resque</span>.enqueue(<span class="type">Jobs</span>::<span class="type">Mail</span>::<span class="type">ConfirmEmail</span>, id)
    <span class="variable-name">true</span>
  <span class="keyword">end</span>

  <span class="comment-delimiter">######### </span><span class="comment">Posts and Such ###############
</span>  <span class="keyword">def</span> <span class="function-name">retract</span>(target, opts={})

    # ... redacted ...

    mailman = <span class="type">Postzord</span>::<span class="type">Dispatcher</span>.build(<span class="variable-name">self</span>, retraction, opts)
    mailman.post

    retraction.perform(<span class="variable-name">self</span>)

    retraction
  <span class="keyword">end</span>

  # ... aaaaand we're done here ...
  </pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/57">
<pre class="extreme">

  <span class="comment-delimiter"># </span><span class="comment">Get the user's like of a post, if there is one.
</span>  <span class="comment-delimiter"># </span><span class="comment">@param [Post] post
</span>  <span class="comment-delimiter"># </span><span class="comment">@return [Like]
</span>  <span class="keyword">def</span> <span class="function-name">like_for</span>(target)
    <span class="keyword">if</span> target.likes.loaded?
      <span class="keyword">return</span> target.likes.detect{ |like| like.author_id == <span class="variable-name">self</span>.person.id }
    <span class="keyword">else</span>
      <span class="keyword">return</span> <span class="type">Like</span>.where(<span class="constant">:author_id</span> =&gt; <span class="variable-name">self</span>.person.id, <span class="constant">:target_type</span> =&gt; target.class.base_class.to_s, <span class="constant">:target_id</span> =&gt; target.id).first
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="comment-delimiter">######### </span><span class="comment">Mailer #######################
</span>  <span class="keyword">def</span> <span class="function-name">mail</span>(job, *args)
    pref = job.to_s.gsub(<span class="string">'Jobs::Mail::'</span>, <span class="string">''</span>).underscore
    <span class="keyword">if</span>(<span class="variable-name">self</span>.disable_mail == <span class="variable-name">false</span> &amp;&amp; !<span class="variable-name">self</span>.user_preferences.exists?(<span class="constant">:email_type</span> =&gt; pref))
      <span class="type">Resque</span>.enqueue(job, *args)
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function-name">mail_confirm_email</span>
    <span class="keyword">return</span> <span class="variable-name">false</span> <span class="keyword">if</span> unconfirmed_email.blank?
    <span class="type">Resque</span>.enqueue(<span class="type">Jobs</span>::<span class="type">Mail</span>::<span class="type">ConfirmEmail</span>, id)
    <span class="variable-name">true</span>
  <span class="keyword">end</span>

  <span class="comment-delimiter">######### </span><span class="comment">Posts and Such ###############
</span>  <span class="keyword">def</span> <span class="function-name">retract</span>(target, opts={})

    # ... redacted ...

    mailman = <span class="type">Postzord</span>::<span class="type">Dispatcher</span>.build(<span class="variable-name">self</span>, retraction, opts)
    mailman.post

    retraction.perform(<span class="variable-name">self</span>)

    retraction
  <span class="keyword">end</span>

  # ... aaaaand we're done here ...
  </pre>


<div class="gigantor squished">(&#x5C6E;&#xFF9F;&#x414;&#xFF9F;)&#x5C6E;</div>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/58">
<h2>Method to Middleware</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/59">
<h3><code class="large">accept_invitation!</code></h3>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/60">
<pre class="xxlarge">
  <span class="keyword">def</span> <span class="function-name">accept_invitation!</span>(opts = {})
    log_hash = {
      <span class="constant">:event</span> =&gt; <span class="constant">:invitation_accepted</span>,
      <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
      <span class="constant">:uid</span> =&gt; <span class="variable-name">self</span>.id
    }

    <span class="keyword">if</span> invitations_to_me.first &amp;&amp; invitations_to_me.first.sender
      log_hash[<span class="constant">:inviter</span>] = invitations_to_me.first.sender.diaspora_handle
    <span class="keyword">end</span>

    <span class="keyword">if</span> <span class="variable-name">self</span>.invited?
      <span class="variable-name">self</span>.setup(opts)
      <span class="variable-name">self</span>.invitation_token = <span class="variable-name">nil</span>
      <span class="variable-name">self</span>.password              = opts[<span class="constant">:password</span>]
      <span class="variable-name">self</span>.password_confirmation = opts[<span class="constant">:password_confirmation</span>]

      <span class="variable-name">self</span>.save
      <span class="keyword">return</span> <span class="keyword">unless</span> <span class="variable-name">self</span>.errors.empty?

      <span class="comment-delimiter"># </span><span class="comment">moved old Invitation#share_with! logic into here,
</span>      <span class="comment-delimiter"># </span><span class="comment">but i don't think we want to destroy the invitation
</span>      <span class="comment-delimiter"># </span><span class="comment">anymore.  we may want to just call self.share_with
</span>      invitations_to_me.each <span class="keyword">do</span> |invitation|
        <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(<span class="variable-name">self</span>.person, invitation.aspect)
          invitation.destroy
        <span class="keyword">end</span>
      <span class="keyword">end</span>

      log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
      <span class="type">Rails</span>.logger.info(log_hash)
      <span class="variable-name">self</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/61">
<pre class="xxlarge">
  <span class="keyword">def</span> <span class="function-name">accept_invitation!</span>(opts = {})
    log_hash = {
      <span class="constant">:event</span> =&gt; <span class="constant">:invitation_accepted</span>,
      <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
      <span class="constant">:uid</span> =&gt; <span class="variable-name">self</span>.id
    }

    <span class="keyword">if</span> invitations_to_me.first &amp;&amp; invitations_to_me.first.sender
      log_hash[<span class="constant">:inviter</span>] = invitations_to_me.first.sender.diaspora_handle
    <span class="keyword">end</span>

    <span class="keyword">if</span> <span class="variable-name">self</span>.invited?
      <b><span class="variable-name">self</span>.setup(opts)</b>
      <span class="variable-name">self</span>.invitation_token = <span class="variable-name">nil</span>
      <span class="variable-name">self</span>.password              = opts[<span class="constant">:password</span>]
      <span class="variable-name">self</span>.password_confirmation = opts[<span class="constant">:password_confirmation</span>]

      <span class="variable-name">self</span>.save
      <span class="keyword">return</span> <span class="keyword">unless</span> <span class="variable-name">self</span>.errors.empty?

      <span class="comment-delimiter"># </span><span class="comment">moved old Invitation#share_with! logic into here,
</span>      <span class="comment-delimiter"># </span><span class="comment">but i don't think we want to destroy the invitation
</span>      <span class="comment-delimiter"># </span><span class="comment">anymore.  we may want to just call self.share_with
</span>      invitations_to_me.each <span class="keyword">do</span> |invitation|
        <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(<span class="variable-name">self</span>.person, invitation.aspect)
          invitation.destroy
        <span class="keyword">end</span>
      <span class="keyword">end</span>

      log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
      <span class="type">Rails</span>.logger.info(log_hash)
      <span class="variable-name">self</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/62">
<pre class="xxlarge">
        <span class="keyword">def</span> <span class="function-name">call</span>(env)
          <span class="variable-name">@user</span> = env[<span class="constant">:user</span>]
          opts = env[<span class="constant">:opts</span>]

          log_hash = {
            <span class="constant">:event</span>    =&gt; <span class="constant">:invitation_accepted</span>,
            <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
            <span class="constant">:uid</span>      =&gt; user.id
          }

          <span class="keyword">if</span> user.invitations_to_me.first &amp;&amp; user.invitations_to_me.first.sender
            log_hash[<span class="constant">:inviter</span>] = user.invitations_to_me.first.sender.diaspora_handle
          <span class="keyword">end</span>

          <span class="keyword">if</span> user.invited?
            user.setup(opts)
            user.invitation_token      = <span class="variable-name">nil</span>
            user.password              = opts[<span class="constant">:password</span>]
            user.password_confirmation = opts[<span class="constant">:password_confirmation</span>]
            user.save

            <span class="keyword">return</span> <span class="keyword">unless</span> user.errors.empty?

            user.invitations_to_me.each <span class="keyword">do</span> |invitation|
              <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(user.person, invitation.aspect)
                invitation.destroy
              <span class="keyword">end</span>
            <span class="keyword">end</span>

            log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
            <span class="type">Rails</span>.logger.info(log_hash)
            user
          <span class="keyword">end</span>

          <span class="comment-delimiter"># </span><span class="comment">call the next middleware
</span>          <span class="variable-name">@app</span>.call
        <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/63">
<pre class="xxlarge">
        <span class="keyword">def</span> <span class="function-name">call</span>(env)
          <b><span class="variable-name">@user</span> = env[<span class="constant">:user</span>]</b>
          <b>opts = env[<span class="constant">:opts</span>]</b>

          log_hash = {
            <span class="constant">:event</span>    =&gt; <span class="constant">:invitation_accepted</span>,
            <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
            <span class="constant">:uid</span>      =&gt; user.id
          }

          <span class="keyword">if</span> user.invitations_to_me.first &amp;&amp; user.invitations_to_me.first.sender
            log_hash[<span class="constant">:inviter</span>] = user.invitations_to_me.first.sender.diaspora_handle
          <span class="keyword">end</span>

          <span class="keyword">if</span> user.invited?
            user.setup(opts)
            user.invitation_token      = <span class="variable-name">nil</span>
            user.password              = opts[<span class="constant">:password</span>]
            user.password_confirmation = opts[<span class="constant">:password_confirmation</span>]
            user.save

            <span class="keyword">return</span> <span class="keyword">unless</span> user.errors.empty?

            user.invitations_to_me.each <span class="keyword">do</span> |invitation|
              <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(user.person, invitation.aspect)
                invitation.destroy
              <span class="keyword">end</span>
            <span class="keyword">end</span>

            log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
            <span class="type">Rails</span>.logger.info(log_hash)
            user
          <span class="keyword">end</span>

          <span class="comment-delimiter"># </span><span class="comment">call the next middleware
</span>          <span class="variable-name">@app</span>.call
        <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/64">
<pre class="xxlarge">
        <span class="keyword">def</span> <span class="function-name">call</span>(env)
          <span class="variable-name">@user</span> = env[<span class="constant">:user</span>]
          opts = env[<span class="constant">:opts</span>]

          log_hash = {
            <span class="constant">:event</span>    =&gt; <span class="constant">:invitation_accepted</span>,
            <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
            <span class="constant">:uid</span>      =&gt; <b>user</b>.id
          }

          <span class="keyword">if</span> <b>user</b>.invitations_to_me.first &amp;&amp; <b>user</b>.invitations_to_me.first.sender
            log_hash[<span class="constant">:inviter</span>] = <b>user</b>.invitations_to_me.first.sender.diaspora_handle
          <span class="keyword">end</span>

          <span class="keyword">if</span> <b>user</b>.invited?
            <b>user</b>.setup(opts)
            <b>user</b>.invitation_token      = <span class="variable-name">nil</span>
            <b>user</b>.password              = opts[<span class="constant">:password</span>]
            <b>user</b>.password_confirmation = opts[<span class="constant">:password_confirmation</span>]
            <b>user</b>.save

            <span class="keyword">return</span> <span class="keyword">unless</span> <b>user</b>.errors.empty?

            <b>user</b>.invitations_to_me.each <span class="keyword">do</span> |invitation|
              <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(<b>user</b>.person, invitation.aspect)
                invitation.destroy
              <span class="keyword">end</span>
            <span class="keyword">end</span>

            log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
            <span class="type">Rails</span>.logger.info(log_hash)
            user
          <span class="keyword">end</span>

          <span class="comment-delimiter"># </span><span class="comment">call the next middleware
</span>          <span class="variable-name">@app</span>.call
        <span class="keyword">end</span>
</pre>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/65">
<pre class="xxlarge">
        <span class="keyword">def</span> <span class="function-name">call</span>(env)
          <span class="variable-name">@user</span> = env[<span class="constant">:user</span>]
          opts = env[<span class="constant">:opts</span>]

          log_hash = {
            <span class="constant">:event</span>    =&gt; <span class="constant">:invitation_accepted</span>,
            <span class="constant">:username</span> =&gt; opts[<span class="constant">:username</span>],
            <span class="constant">:uid</span>      =&gt; user.id
          }

          <span class="keyword">if</span> user.invitations_to_me.first &amp;&amp; user.invitations_to_me.first.sender
            log_hash[<span class="constant">:inviter</span>] = user.invitations_to_me.first.sender.diaspora_handle
          <span class="keyword">end</span>

          <span class="keyword">if</span> user.invited?
            user.setup(opts)
            user.invitation_token      = <span class="variable-name">nil</span>
            user.password              = opts[<span class="constant">:password</span>]
            user.password_confirmation = opts[<span class="constant">:password_confirmation</span>]
            user.save

            <span class="keyword">return</span> <span class="keyword">unless</span> user.errors.empty?

            user.invitations_to_me.each <span class="keyword">do</span> |invitation|
              <span class="keyword">if</span> !invitation.admin? &amp;&amp; invitation.sender.share_with(user.person, invitation.aspect)
                invitation.destroy
              <span class="keyword">end</span>
            <span class="keyword">end</span>

            log_hash[<span class="constant">:status</span>] = <span class="string">"success"</span>
            <span class="type">Rails</span>.logger.info(log_hash)
            user
          <span class="keyword">end</span>

          <span class="comment-delimiter"># </span><span class="comment">call the next middleware
</span>          <b><span class="variable-name">@app</span>.call</b>
        <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/66">
<pre class="large">
    <span class="keyword">def</span> <span class="function-name">setup</span>(opts)
      user.username    = opts[<span class="constant">:username</span>]
      user.email       = opts[<span class="constant">:email</span>]
      user.language    = opts[<span class="constant">:language</span>]
      user.language || = <span class="type">I18n</span>.locale.to_s
      user.valid?
      errors = user.errors
      errors.delete <span class="constant">:person</span>
      <span class="keyword">return</span> <span class="keyword">if</span> errors.size &gt; 0
      user.set_person(<span class="type">Person</span>.new(opts[<span class="constant">:person</span>] || {} ))
      user.generate_keys
    <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/67">
<pre class="large">
    <span class="keyword">def</span> <span class="function-name">setup</span>(opts)
      <b>user</b>.username    = opts[<span class="constant">:username</span>]
      <b>user</b>.email       = opts[<span class="constant">:email</span>]
      <b>user</b>.language    = opts[<span class="constant">:language</span>]
      <b>user</b>.language || = <span class="type">I18n</span>.locale.to_s
      <b>user</b>.valid?
      errors = <b>user</b>.errors
      errors.delete <span class="constant">:person</span>
      <span class="keyword">return</span> <span class="keyword">if</span> errors.size &gt; 0
      <b>user</b>.set_person(<span class="type">Person</span>.new(opts[<span class="constant">:person</span>] || {} ))
      <b>user</b>.generate_keys
    <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/68">
<pre style="font-size: 1.9em">
<span class="keyword">class</span> <span class="type">InvitationsController</span> &lt; <span class="type">Devise</span>::<span class="type">InvitationsController</span>
  <span class="keyword">def</span> <span class="function-name">update</span>
    <span class="comment-delimiter"># </span><span class="comment">... omitted ...
</span>
    user = <span class="type">User</span>.find_by_invitation_token!(invitation_token)

    user.accept_invitation!(params[<span class="constant">:user</span>])

    <span class="comment-delimiter"># </span><span class="comment">... omitted ...
</span>  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/69">
<pre style="font-size: 2em">
<span class="keyword">class</span> <span class="type">User</span> &lt; <span class="type">ActiveRecord</span>::<span class="type">Base</span>
  <span class="keyword">def</span> <span class="function-name">accept_invitation!</span>(opts = {})
    accept = <span class="type">Middleware</span>::<span class="type">AcceptInvitation</span>.new(lambda {})
    accept.call(opts.merge(<span class="constant">:user</span> =&gt; <span class="variable-name">self</span>))

    <span class="comment-delimiter"># </span><span class="comment">or
</span>
    run(<span class="constant">:accept_invitation</span>, opts.merge(<span class="constant">:user</span> =&gt; <span class="variable-name">self</span>))
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/70">
<pre style="font-size: 2em">
<span class="keyword">class</span> <span class="type">User</span> &lt; <span class="type">ActiveRecord</span>::<span class="type">Base</span>
  <span class="keyword">def</span> <span class="function-name">accept_invitation!</span>(opts = {})
    accept = <span class="type">Middleware</span>::<span class="type">AcceptInvitation</span>.new(lambda {})
    accept.call(opts.merge(<span class="constant">:user</span> =&gt; <span class="variable-name">self</span>))

    <span class="comment-delimiter"># </span><span class="comment">or
</span>
    <b>run(<span class="constant">:accept_invitation</span>, opts.merge(<span class="constant">:user</span> =&gt; <span class="variable-name">self</span>))</b>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/71">
<h2>And Then&#x203D;</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/72">
<pre>
noob_stack = <span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">AcceptInvite</span>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">Noob</span>
<span class="keyword">end</span>

veteran_stack = <span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">AcceptInvite</span>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">Veteran</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/73">
<pre>
noob_stack = <span class="type">Builder</span>.new <span class="keyword">do</span>
  <b>use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">AcceptInvite</span></b>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">Noob</span>
<span class="keyword">end</span>

veteran_stack = <span class="type">Builder</span>.new <span class="keyword">do</span>
  <b>use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">AcceptInvite</span></b>
  use <span class="type">Actions</span>::<span class="type">User</span>::<span class="type">Veteran</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/74">
<pre>
it <span class="string">"should setup the user"</span> <span class="keyword">do</span>
  mock.expects(<span class="constant">:setup</span>)
  <span class="variable-name">@middleware</span>.call(<span class="constant">:user</span> =&gt; mock)
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/75">
<h1>Where else?</h1></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/76">
<h2>Reuse</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/77">
<pre>
    <span class="type">Builder</span>.new <span class="keyword">do</span>
      use <span class="type">Bar</span>
      use <span class="type">Baz</span>
      use <span class="type">Bak</span>
    <span class="keyword">end</span>

    <span class="type">Builder</span>.new <span class="keyword">do</span>
      use <span class="type">Bar</span>
      use <span class="type">Bang</span>
      use <span class="type">Bok</span>
    <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/78">
<pre>
    <span class="type">Builder</span>.new <span class="keyword">do</span>
      <b>use <span class="type">Bar</span></b>
      use <span class="type">Baz</span>
      use <span class="type">Bak</span>
    <span class="keyword">end</span>

    <span class="type">Builder</span>.new <span class="keyword">do</span>
      <b>use <span class="type">Bar</span></b>
      use <span class="type">Bang</span>
      use <span class="type">Bok</span>
    <span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/79">
<h2>Serial Invocation</h2></div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/80">
<pre>
<span class="keyword">def</span> <span class="function-name">foo</span>
  bar(1)
  baz(1, 2)
  bak(<span class="string">"fing"</span>)
<span class="keyword">end</span>
</pre>




<div class="centered-arrow" style="margin-left: -60px;">&#x2192;</div>




<pre class="right">
<span class="type">Builder</span>.new <span class="keyword">do</span>
  use <span class="type">Bar</span>, 1
  use <span class="type">Baz</span>, 1, 2
  use <span class="type">Bak</span>, <span class="string">"fing"</span>
<span class="keyword">end</span>
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/01_slide/81">
<h2>Composition</h2></div>
</div><div class="slide" data-transition="none"><div class="content code-center" ref="one/01_slide/82">
<pre class="top">
<span class="keyword">def</span> <span class="function-name">foo</span>
  bar(baz(bak(<span class="string">"fing"</span>)))
<span class="keyword">end</span>
</pre>


<div class="centered-arrow" style="margin-top: -80px; font-size: 13em">&#x2193;</div>


<pre class="bottom">
<span class="type">Builder</span>.new {
  use <span class="type">Bak</span>
  use <span class="type">Baz</span>
  use <span class="type">Bar</span>
}.call(<span class="string">"fing"</span>)
</pre>


</div>
</div><div class="slide" data-transition="none"><div class="content bullets mono-bullets thanks" ref="one/01_slide/83">
<h1>( * &#x2312;&#x25BD;&#x2312; * )</h1>

<ul>
<li>@johnbender</li>
<li>johnbender.us</li>
<li>github.com/johnbender</li>
</ul>
</div>
</div></div>

</body>
</html>
